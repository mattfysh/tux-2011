<?xml version="1.0"?>
<project name="tux" default="build" basedir="../">

	<property name="jshint.flags" value="browser=true,maxerr=25,undef=true,curly=true,debug=true,eqeqeq=true,immed=true,newcap=true,onevar=true,plusplus=true,strict=true" />
	<property name="jshint.predef" value="console,$,namespace,noop,tux,Backbone,Store,_,format,parse" />
	<property name="jshint.predef.test" value="${jshint.predef},describe,xdescribe,xit,it,beforeEach,afterEach,expect,sinon,jasmine,loadFixtures,setFixtures,loadTemplate" />
	
	<target name="build">
		<antcall target="lint-src" />
		<antcall target="lint-tests" />
		<antcall target="test" />
		<antcall target="build-all-apps" />
	</target>

	<!-- lint source -->
	<target name="lint-src">
		<antcall target="lint">
			<param name="dir" value="src" />
			<param name="predef" value="${jshint.predef}" />
		</antcall>
	</target>

	<!-- lint tests -->
	<target name="lint-tests">
		<antcall target="lint">
			<param name="dir" value="specs" />
			<param name="predef" value="${jshint.predef.test}" />
		</antcall>
	</target>

	<!-- lint -->
	<target name="lint">
		<apply dir="build" executable="java" failonerror="true">
			<fileset dir="${dir}" includes="**/*.js" />
			<arg line="-jar rhino.jar jshint-rhino.js" />
			<srcfile />
			<arg value="${jshint.flags}" />
			<arg value="${predef}" />
		</apply>
		<echo>${dir} JSHint Passed</echo>
	</target>

	<!-- run unit tests -->
	<target name="test">
		<java failonerror="true" jar="build/JsTestDriver-1.3.2.jar" fork="true">
			<arg line="--reset --tests all" />
		</java>
		<echo>Jasmine Specs Passed</echo>
	</target>
			
	<!-- build each app -->
	<target name="build-all-apps">
		<copy file="src/util.js" tofile="scripts/util.js" />
		<subant target="build-app" genericantfile="build/build.xml">
			<dirset dir="src" includes="*" />
		</subant>
		<echo>All apps built</echo>
	</target>
	
	<target name="build-app">
		<basename file="${basedir}" property="app" />
		<property name="appfile" value="../../scripts/${app}.js" />
		
		<!-- concat src js -->
		<concat destfile="${appfile}">
			<fileset dir="." includes="*.js" />
		</concat>
		
		<!-- namespace the templates -->
		<echo file="${appfile}" append="true">namespace('tux.${app}');${line.separator}</echo>
		
		<!-- append compiled jst files -->
		<apply dir="../../build" executable="java" output="${appfile}" append="true">
			<fileset dir="jst" includes="*.jst" />
			<arg line="-jar rhino.jar compile-jst.js" />
			<srcfile />
		</apply>
		
		<!-- build compressed version -->
		<java jar="../../build/compiler.jar" fork="true" dir="../../scripts">
			<arg line="--js ${app}.js --js_output_file ${app}.min.js" />
		</java>
		
		<echo>${app} app build successful</echo>
	</target>
	
	

</project>
